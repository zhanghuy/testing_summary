## ocr+检索集群性能摸底压测
1. 压测目的：
  元旦高峰+服务的增加和更新，对ocr，甚至包括检索的集群进行性能摸底，准备预案。
  压测目标：对ocr侧做**极限压测找到临界值**，在业务服务正常的情况下(**无大量超时**，**无502**，**cpu idle > 60**)，并关注**服务稳定性**，以及**接口耗时**。
2. 发压和被压环境
  压测工具：stress - 通过脚本构造请求格式，使用随机图片和cuid
  执行命令：
> date;echo "POST Cookie:cuid=QAPerfTestA8B0A287D3DE9CD7{RI[1000000000-9999999999]}%7C0 https://jiazhang.zuoyebang.com/parentsearch/ocr/picfusesearch?skip=rdqa&source=         form:image:picfuse_week/{RI[1-25000]}.jpg" | ./stress attack -rate=500 -duration=300s;date
  发压：192.168.236.180 - **物理机 , 32核，128G**
  被压：线上环境 - https://jiazhang.zuoyebang.com
3. 数据指标
  接口耗时参照【线上parentsearch集群批搜接口耗时情况】【区间760ms-2s】
  压测起始qps为500（包含压测流量、家长版线上流量及主端线上流量）
4. 测试步骤
  第一轮实发420QPS，线上家长版+主端整页拍60QPS，共**480**QPS，持续时间5min，保证接口正常返回的情况下(无超时，无502)，ocr与检索各服务指标正常。
  第二轮实发470QPS，线上家长版+主端整页拍80QPS，共**550**QPS，持续时间5min，保证接口正常返回的情况下(无超时，无502)，ocr与检索各服务指标正常。
  第三轮实发470QPS，线上家长版+主端整页拍160QPS，共**630**QPS，持续时间5min，保证接口正常返回的情况下(无超时，无502)，部分**批搜服务开始不太稳定**。
**批搜服务开始不太稳定**：压力太大，超时变多，触发故障机器自动屏蔽策略
5. 压测总结
  qps达到**630qps**时，批搜测部分服务开始不稳定，达到了ocr测服务机器扩容目的。
6. 压测记录
```ruby
[homework@rdqa-yace-236-180 zhanghui]$ date;echo "POST Cookie:cuid=QAPerfTestA8B0A287D3DE9CD7{RI[1000000000-9999999999]}%7C0 https://jiazhang.zuoyebang.com/parentsearch/ocr/picfusesearch?skip=rdqa form:image:picfuse_week/{RI[1-25000]}.jpg" | ./stress attack -rate=470 -duration=300s;date
Fri Nov 29 17:01:54 CST 2019
2019/11/29 17:01:54 Stress is attacking 1 targets in random order and 470 rate for 5m0s...
2019/11/29 17:07:16 Done! Writing results to 'result.json'...
Requests [total] 141000
Duration [total] 5m17.927419059s
QPS [mean] 443.497451
Latencies [mean, 50, 95, 99, max] 1.391734913s, 1.313264262s, 2.845280538s, 5.304611866s, 5.304611866s
Bytes In [total, mean] 786121467, 5575.33
Bytes Out [total, mean] 11983379722, 84988.51
Success [ratio] 100.00%
Status Codes [code:count] 200:141000
Error Set:
Fri Nov 29 17:07:16 CST 2019
```
***
 parentsearch集群（批搜相关服务）（107核）
```
  ip     | cpu(核) | 内存(G)| cgi(个)| 类型
  ------ | ------- | ----- | ------ | --- 
 128.73  |    11   |   40  |   256  | 虚拟机
 145.13  |    32   |   128 |   1024 | 物理机
 149.64  |    32   |   128 |   1024 | 物理机
 144.228 |    32   |   128 |   1024 | 物理机
 ```
